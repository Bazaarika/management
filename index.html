<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bazaarika ‚Äì Partnership Ledger (v2)</title>
  <style>
    :root{
      --bg:#0f172a; --card:#111827; --muted:#94a3b8; --text:#e5e7eb; --accent:#22c55e; --danger:#ef4444; --warn:#f59e0b;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif;background:linear-gradient(180deg,#0b1220,#0f172a 30%);color:var(--text)}
    header{position:sticky;top:0;background:rgba(2,6,23,.8);backdrop-filter:blur(8px);border-bottom:1px solid #1f2937;z-index:2}
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    h1{font-size:clamp(20px,3vw,28px);margin:0}
    .grid{display:grid;gap:12px}
    .g2{grid-template-columns:repeat(2,minmax(0,1fr))}
    @media(max-width:840px){.g2{grid-template-columns:1fr}}
    .card{background:linear-gradient(180deg,#0b1220,#0a1020);border:1px solid #1f2937;border-radius:16px;padding:14px;box-shadow:0 6px 24px rgba(0,0,0,.25)}
    label{font-size:.88rem;color:var(--muted)}
    input,select,textarea{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #263246;background:#0b1220;color:var(--text)}
    textarea{min-height:64px;resize:vertical}
    button{cursor:pointer;border:0;border-radius:12px;padding:10px 14px;font-weight:600}
    .btn{background:linear-gradient(90deg,#22c55e,#16a34a);color:#06110a}
    .btn.secondary{background:#1f2937;color:#e5e7eb;border:1px solid #374151}
    .btn.warn{background:linear-gradient(90deg,#f59e0b,#d97706);color:#0b0b0b}
    .btn.danger{background:linear-gradient(90deg,#ef4444,#dc2626);color:#1b0a0a}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    .row>*{flex:1 1 160px}
    .kpi{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-radius:12px;background:#0d1526;border:1px solid #21324d}
    .muted{color:var(--muted)}
    .tag{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid #334155;color:#cbd5e1;font-size:.78rem}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid #1f2937;text-align:left}
    th{position:sticky;top:0;background:#0b1220;z-index:1}
    tr:hover td{background:#0a1424}
    .right{text-align:right}
    .toast{position:fixed;right:16px;bottom:16px;background:#0b1220;border:1px solid #1f2937;padding:12px 14px;border-radius:12px;box-shadow:0 8px 30px rgba(0,0,0,.45);opacity:0;transform:translateY(10px);transition:all .25s}
    .toast.show{opacity:1;transform:none}
    .pill{border-radius:999px;padding:2px 8px;border:1px solid #334155;background:#0b1220}
    .footer{color:#94a3b8;font-size:.86rem;margin-top:8px}
    .danger-text{color:#fecaca}
    .settlement-card h4 {margin:0 0 10px 0;}
    .settlement-list p {margin:5px 0; display:flex; justify-content:space-between; align-items:center; }
    .settlement-list .positive {color:var(--accent);}
    .settlement-list .negative {color:var(--danger);}
    .chart-container{padding:10px;height:300px;background:#0b1220;border-radius:10px}
    .chart-container canvas{width:100% !important;height:100% !important;}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <header>
    <div class="wrap row" style="align-items:center;gap:12px">
      <h1>üìí Bazaarika ‚Äì Partnership Ledger</h1>
      <span class="pill" id="status">Disconnected</span>
      <span class="pill" id="lastSync">Last sync: ‚Äì</span>
    </div>
  </header>

  <main class="wrap grid" style="margin-top:12px">
    <section class="grid g2">
      <div class="card">
        <div class="row">
          <div class="kpi"><div>Total Contributions</div><div class="right" id="kpiContrib">‚Çπ0</div></div>
          <div class="kpi"><div>Total Expenses</div><div class="right" id="kpiExpense">‚Çπ0</div></div>
          <div class="kpi"><div>Current Balance</div><div class="right" id="kpiBalance">‚Çπ0</div></div>
        </div>
        <div class="footer">Calculated from synced data</div>
      </div>

      <div class="card">
        <div class="row">
          <div style="flex:2 1 240px">
            <label for="blobUrl">JSONBlob URL</label>
            <input id="blobUrl" value="https://jsonblob.com/api/jsonBlob/1406533281540923392" />
          </div>
          <div style="display:flex;gap:8px;align-items:flex-end">
            <button class="btn secondary" id="btnLoad">Reload</button>
            <button class="btn" id="btnInit">Initialize</button>
            <button class="btn warn" id="btnBackup">Export JSON</button>
            <button class="btn secondary" id="btnCSV">Export CSV</button>
          </div>
        </div>
        <div class="footer">Note: <b>Initialize</b> only if the blob is empty or corrupted (it will not delete valid data).</div>
      </div>
    </section>

    <section class="grid g2">
      <div class="card">
        <h3 style="margin-top:0">üë• Partner ‡§ú‡•ã‡§°‡§º‡•á‡§Ç</h3>
        <div class="row">
          <div>
            <label>‡§®‡§æ‡§Æ</label>
            <input id="pName" placeholder="‡§â‡§¶‡§æ. Ravi Kumar" />
          </div>
          <div>
            <label>‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤/‡§®‡•ã‡§ü</label>
            <input id="pNote" placeholder="‡§â‡§¶‡§æ. 98xxxxxx" />
          </div>
          <div>
            <label>Role</label>
            <select id="pRole">
              <option value="member">Member</option>
              <option value="admin">Admin</option>
            </select>
          </div>
        </div>
        <div class="row">
          <button class="btn" id="addPartner">Add Partner</button>
        </div>
        <div class="footer">Partner ‡§ú‡•ã‡§°‡§º‡§®‡•á ‡§ï‡•á ‡§¨‡§æ‡§¶ ‡§®‡•Ä‡§ö‡•á ‡§ï‡•Ä ‡§∏‡•Ç‡§ö‡•Ä ‡§Æ‡•á‡§Ç ‡§¶‡§ø‡§ñ‡•á‡§ó‡§æ‡•§</div>
      </div>

      <div class="card">
        <h3 style="margin-top:0">‚ûï Entry ‡§ú‡•ã‡§°‡§º‡•á‡§Ç</h3>
        <div class="row">
          <div>
            <label>Type</label>
            <select id="eType">
              <option value="contribution">Contribution (‡§ú‡§Æ‡§æ)</option>
              <option value="expense">Expense (‡§ñ‡§∞‡•ç‡§ö)</option>
            </select>
          </div>
          <div>
            <label>Amount (‚Çπ)</label>
            <input id="eAmount" type="number" step="0.01" placeholder="1000" />
          </div>
          <div>
            <label>Date</label>
            <input id="eDate" type="date" />
          </div>
        </div>
        <div class="row">
          <div>
            <label>Paid / By</label>
            <select id="eBy"></select>
          </div>
          <div>
            <label>Category</label>
            <input id="eCat" placeholder="‡§â‡§¶‡§æ. Marketing, Rent, Inventory" />
          </div>
        </div>
        <div class="row">
          <div style="flex:1 1 100%">
            <label>Notes</label>
            <textarea id="eNote" placeholder="Short details"></textarea>
          </div>
        </div>
        <div class="row">
            <div style="flex:1 1 100%">
                <label>Attachment (Optional)</label>
                <input type="file" id="eFile" accept="image/*" />
            </div>
        </div>
        <div class="row">
          <button class="btn" id="addEntry">Save Entry</button>
          <button class="btn secondary" id="resetEntry">Reset</button>
        </div>
        <div class="footer">Contribution ‡§Æ‡•á‡§Ç ‡§¶‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ ‡§™‡•à‡§∏‡§æ ‡§™‡•Ç‡§≤ ‡§Æ‡•á‡§Ç ‡§ú‡•Å‡§°‡§º‡§§‡§æ ‡§π‡•à; Expense ‡§Æ‡•á‡§Ç ‡§ï‡§Ç‡§™‡§®‡•Ä ‡§ï‡•á ‡§ñ‡§∞‡•ç‡§ö ‡§ò‡§ü‡§§‡•á ‡§π‡•à‡§Ç‡•§</div>
      </div>
    </section>

    <section class="card">
      <div class="row" style="align-items:end">
        <div>
          <h3 style="margin:0">üë• Partners</h3>
          <div class="muted">‡§ï‡§ø‡§∏‡§®‡•á ‡§ï‡§ø‡§§‡§®‡§æ ‡§Ø‡•ã‡§ó‡§¶‡§æ‡§® ‡§ï‡§ø‡§Ø‡§æ ‚Äì ‡§∏‡§Ç‡§ï‡•ç‡§∑‡•á‡§™</div>
        </div>
        <div class="row" style="margin-left:auto;gap:6px">
          <input id="partnerSearch" placeholder="Search partner" style="max-width:240px" />
          <button class="btn secondary" id="refreshPartners">Refresh</button>
        </div>
      </div>
      <div style="overflow:auto;margin-top:8px">
        <table id="partnersTbl">
          <thead><tr>
            <th>#</th><th>‡§®‡§æ‡§Æ</th><th>Role</th><th>‡§®‡•ã‡§ü</th><th class="right">Total Contribution (‚Çπ)</th><th class="right">Net Balance (‚Çπ)</th><th>Actions</th>
          </tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <section class="grid g2">
      <div class="card">
        <div class="row" style="align-items:end;margin-bottom:10px">
          <div>
            <h3 style="margin:0">üìä Charts</h3>
            <div class="muted">Monthly Trends & Category-wise Expense</div>
          </div>
        </div>
        <div class="chart-container">
          <canvas id="monthlyTrendChart"></canvas>
        </div>
        <div class="chart-container" style="margin-top:10px">
          <canvas id="categoryChart"></canvas>
        </div>
      </div>
      <div class="card settlement-card">
        <div class="row" style="align-items:end;margin-bottom:10px">
          <div>
            <h3 style="margin:0">ü§ù Settlement Suggestion</h3>
            <div class="muted">‡§ï‡•å‡§® ‡§ï‡§ø‡§∏‡§ï‡•ã ‡§ï‡§ø‡§§‡§®‡§æ ‡§¶‡•á‡§ó‡§æ?</div>
          </div>
          <button class="btn" id="btnSettlement">Show Settlement</button>
        </div>
        <div id="settlementResult" class="settlement-list">
          <p>Please click 'Show Settlement' to calculate the balances.</p>
        </div>
      </div>
    </section>

    <section class="card">
      <div class="row" style="align-items:end">
        <div>
          <h3 style="margin:0">üìú Ledger</h3>
          <div class="muted">‡§∏‡§≠‡•Ä ‡§è‡§Ç‡§ü‡•ç‡§∞‡•Ä ‚Äì ‡§´‡§º‡§ø‡§≤‡•ç‡§ü‡§∞/‡§∏‡§∞‡•ç‡§ö ‡§â‡§™‡§≤‡§¨‡•ç‡§ß</div>
        </div>
        <div class="row" style="margin-left:auto;gap:6px">
          <select id="fType" style="max-width:160px">
            <option value="">All Types</option>
            <option value="contribution">Contribution</option>
            <option value="expense">Expense</option>
          </select>
          <select id="fBy" style="max-width:200px"></select>
          <input id="fText" placeholder="Search note/category" style="max-width:260px" />
          <button class="btn secondary" id="applyFilter">Apply</button>
          <button class="btn secondary" id="clearFilter">Clear</button>
        </div>
      </div>
      <div style="overflow:auto;margin-top:8px">
        <table id="ledgerTbl">
          <thead><tr>
            <th>Date</th><th>Type</th><th>By</th><th>Category</th><th>Notes</th><th class="right">Amount (‚Çπ)</th><th>Actions</th>
          </tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>
  </main>

  <div id="toast" class="toast">Saved</div>

  <script>
    // ====== Configuration ======
    const ImgbbAPIKey = '934c04f7429baab4fd5cd0ea4ad657e9';
    const els = (sel,root=document)=>[...root.querySelectorAll(sel)];
    const $ = (sel,root=document)=>root.querySelector(sel);

    let currentUser = { id: 'guest', role: 'member' }; // Default user

    const state = {
      data: null,
      filtered: null,
      partnersMap: new Map(),
      partnerNetBalances: {},
    };

    let monthlyTrendChart, categoryChart;

    function fmtMoney(n){
      if(isNaN(n)) return '‚Çπ'+Number(0).toLocaleString('en-IN', {maximumFractionDigits:2});
      const sign = n < 0 ? '-' : '';
      return sign + '‚Çπ'+Math.abs(Number(n)).toLocaleString('en-IN', {maximumFractionDigits:2});
    }

    function uid(){return 'id_'+Math.random().toString(36).slice(2)+Date.now().toString(36)}

    function today(){
      const d = new Date();
      const off = d.getTimezoneOffset();
      const d2 = new Date(d.getTime() - off*60*1000);
      return d2.toISOString().slice(0,10);
    }

    function toast(msg){
      const t = $('#toast');
      t.textContent = msg; t.classList.add('show');
      setTimeout(()=>t.classList.remove('show'), 2000);
    }

    function getBlobUrl(){ return $('#blobUrl').value.trim(); }

    async function fetchData(){
      const url = getBlobUrl();
      $('#status').textContent = 'Connecting‚Ä¶';
      try{
        const res = await fetch(url, {headers:{'Accept':'application/json'}});
        if(!res.ok) throw new Error('HTTP '+res.status);
        const json = await res.json().catch(()=>({}));
        if(!json || typeof json !== 'object' || !Array.isArray(json.partners) || !Array.isArray(json.entries)){
          state.data = { partners:[], entries:[], meta:{createdAt: new Date().toISOString()} };
          $('#status').textContent = 'Needs Init';
          $('#status').style.background = '#1f2937';
          $('#lastSync').textContent = 'Last sync: structure missing ‚Äì click Initialize';
          renderAll();
          return;
        }
        state.data = json;
        localStorage.setItem('ledger_cache', JSON.stringify(json));
        $('#status').textContent = 'Connected';
        $('#status').style.background = '#0b2e1a';
        $('#lastSync').textContent = 'Last sync: '+ new Date().toLocaleString();
        
        // Check for admin role and update currentUser
        const adminPartner = state.data.partners.find(p => p.role === 'admin');
        if (adminPartner) {
            currentUser = { id: adminPartner.id, role: 'admin' };
        } else if (state.data.partners.length > 0) {
            currentUser = { id: state.data.partners[0].id, role: 'member' };
        }
        
        renderAll();
      }catch(err){
        console.error(err);
        const cache = localStorage.getItem('ledger_cache');
        if(cache){
          state.data = JSON.parse(cache);
          $('#status').textContent = 'Offline (cache)';
          $('#status').style.background = '#3f1d1d';
          $('#lastSync').textContent = 'Loaded from cache';
          renderAll();
        }else{
          $('#status').textContent = 'Error';
          $('#status').style.background = '#3f1d1d';
          toast('Load failed');
        }
      }
    }

    async function saveData(){
      const url = getBlobUrl();
      const body = JSON.stringify(state.data);
      try{
        const res = await fetch(url, {method:'PUT', headers:{'Content-Type':'application/json','Accept':'application/json','X-Requested-With':'XMLHttpRequest'}, body});
        if(!res.ok) throw new Error('HTTP '+res.status);
        $('#status').textContent = 'Saved';
        $('#status').style.background = '#0b2e1a';
        $('#lastSync').textContent = 'Saved: '+ new Date().toLocaleString();
        localStorage.setItem('ledger_cache', body);
        toast('Saved to JSONBlob');
      }catch(err){
        console.error(err);
        toast('Save failed');
      }
    }

    async function initializeBlob(){
      if(!confirm('Initialize minimal structure if missing. Existing valid data will NOT be deleted. Continue?')) return;
      const url = getBlobUrl();
      let cur = null;
      try{
        const res = await fetch(url,{headers:{'Accept':'application/json'}});
        cur = await res.json().catch(()=>null);
      }catch{cur=null}
      if(cur && Array.isArray(cur.partners) && Array.isArray(cur.entries)){
        toast('Already initialized');
        state.data = cur; renderAll(); return;
      }
      state.data = {partners:[], entries:[], meta:{createdAt:new Date().toISOString(), app:'Bazaarika Ledger v2'}};
      await saveData();
      renderAll();
    }

    // ====== Rendering ======
    function buildPartnersMap(){
      state.partnersMap = new Map();
      (state.data.partners||[]).forEach(p=>state.partnersMap.set(p.id,p));
    }

    function calculateBalances(){
      const contribTotals = new Map();
      const expTotals = new Map();
      const numPartners = state.data.partners.length;
      const totalExpense = state.data.entries.filter(e=>e.type==='expense').reduce((s,e)=>s+Number(e.amount||0),0);
      const equalExpenseShare = numPartners > 0 ? totalExpense / numPartners : 0;

      state.data.entries.forEach(e => {
        if(e.type === 'contribution') {
          contribTotals.set(e.by, (contribTotals.get(e.by) || 0) + Number(e.amount || 0));
        }
      });
      
      const balances = {};
      state.data.partners.forEach(p => {
          const contrib = contribTotals.get(p.id) || 0;
          balances[p.id] = contrib - equalExpenseShare;
      });
      state.partnerNetBalances = balances;
    }

    function renderSummary(){
      const entries = state.data.entries||[];
      const contrib = entries.filter(e=>e.type==='contribution').reduce((s,e)=>s+Number(e.amount||0),0);
      const exp = entries.filter(e=>e.type==='expense').reduce((s,e)=>s+Number(e.amount||0),0);
      $('#kpiContrib').textContent = fmtMoney(contrib);
      $('#kpiExpense').textContent = fmtMoney(exp);
      $('#kpiBalance').textContent = fmtMoney(contrib-exp);
    }

    function renderPartnerSelects(){
      const by = $('#eBy');
      const fBy = $('#fBy');
      by.innerHTML = '';
      fBy.innerHTML = '';
      const optAny = document.createElement('option'); optAny.value=''; optAny.textContent='All Partners'; fBy.appendChild(optAny);
      (state.data.partners||[]).forEach(p=>{
        const o = document.createElement('option'); o.value=p.id; o.textContent=p.name; by.appendChild(o);
        const o2 = document.createElement('option'); o2.value=p.id; o2.textContent=p.name; fBy.appendChild(o2);
      });
    }

    function renderPartners(){
      const q = $('#partnerSearch').value.toLowerCase();
      const tbody = $('#partnersTbl tbody');
      tbody.innerHTML = '';
      const contribTotals = new Map();
      (state.data.entries||[]).filter(e=>e.type==='contribution').forEach(e=>{
        const k = e.by; contribTotals.set(k,(contribTotals.get(k)||0)+Number(e.amount||0));
      });
      (state.data.partners||[])
        .filter(p=>!q || p.name.toLowerCase().includes(q) || (p.note||'').toLowerCase().includes(q) || (p.role||'').toLowerCase().includes(q))
        .forEach((p,i)=>{
          const tr = document.createElement('tr');
          const netBalance = state.partnerNetBalances[p.id] || 0;
          const balanceClass = netBalance >= 0 ? 'positive' : 'negative';
          const actions = currentUser.role === 'admin' ? 
              `<button class="btn secondary" data-act="editP" data-id="${p.id}">Edit</button>
               <button class="btn danger" data-act="delP" data-id="${p.id}">Delete</button>` :
              `<span class="muted">No actions</span>`;
          tr.innerHTML = `<td>${i+1}</td>
            <td>${p.name}</td>
            <td>${p.role}</td>
            <td class="muted">${p.note||''}</td>
            <td class="right">${fmtMoney(contribTotals.get(p.id)||0)}</td>
            <td class="right ${balanceClass}">${fmtMoney(netBalance)}</td>
            <td>${actions}</td>`;
          tbody.appendChild(tr);
        });
    }

    function renderLedger(){
      buildPartnersMap();
      const tbody = $('#ledgerTbl tbody');
      tbody.innerHTML = '';
      const t = $('#fType').value; const b = $('#fBy').value; const txt = $('#fText').value.toLowerCase();
      const rows = (state.data.entries||[])
        .filter(e=>!t || e.type===t)
        .filter(e=>!b || e.by===b)
        .filter(e=>!txt || (e.note||'').toLowerCase().includes(txt) || (e.category||'').toLowerCase().includes(txt))
        .sort((a,b)=> (b.date||'').localeCompare(a.date||''));
      rows.forEach(e=>{
        const tr = document.createElement('tr');
        const by = state.partnersMap.get(e.by)?.name || '‚Äî';
        const typeTag = e.type==='contribution'?'<span class="tag">Contribution</span>':'<span class="tag">Expense</span>';
        
        let actions = '';
        if (currentUser.role === 'admin' || e.by === currentUser.id) {
            actions = `<button class="btn secondary" data-act="editE" data-id="${e.id}">Edit</button>`;
        }
        if (currentUser.role === 'admin') {
            actions += `<button class="btn danger" data-act="delE" data-id="${e.id}">Delete</button>`;
        }
        if (!actions) actions = `<span class="muted">No actions</span>`;

        const attachmentLink = e.attachmentUrl ? `<a href="${e.attachmentUrl}" target="_blank" class="muted" style="text-decoration:none">üì∑</a>` : '';

        tr.innerHTML = `<td>${e.date||''}</td>
          <td>${typeTag}</td>
          <td>${by}</td>
          <td>${e.category||''}</td>
          <td class="muted">${e.note||''} ${attachmentLink}</td>
          <td class="right">${fmtMoney(e.amount)}</td>
          <td>${actions}</td>`;
        tbody.appendChild(tr);
      });
    }
    
    function renderCharts() {
        if (monthlyTrendChart) monthlyTrendChart.destroy();
        if (categoryChart) categoryChart.destroy();
        
        const monthlyData = {};
        const categoryData = {};
        const now = new Date();
        const firstDayOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);

        state.data.entries.forEach(e => {
            const date = e.date || today();
            const month = date.slice(0, 7);
            if (!monthlyData[month]) monthlyData[month] = { contribution: 0, expense: 0 };
            monthlyData[month][e.type] += Number(e.amount || 0);

            if (e.type === 'expense' && e.category) {
                const category = e.category.toLowerCase();
                categoryData[category] = (categoryData[category] || 0) + Number(e.amount || 0);
            }
        });
        
        const months = Object.keys(monthlyData).sort();
        const contribs = months.map(m => monthlyData[m].contribution);
        const expenses = months.map(m => monthlyData[m].expense);
        
        const categories = Object.keys(categoryData);
        const amounts = Object.values(categoryData);

        const monthlyCtx = $('#monthlyTrendChart').getContext('2d');
        monthlyTrendChart = new Chart(monthlyCtx, {
            type: 'line',
            data: {
                labels: months,
                datasets: [{
                    label: 'Contributions',
                    data: contribs,
                    borderColor: 'rgb(34, 197, 94)',
                    tension: 0.1
                }, {
                    label: 'Expenses',
                    data: expenses,
                    borderColor: 'rgb(239, 68, 68)',
                    tension: 0.1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: { color: 'rgba(255,255,255,0.1)' }
                    },
                    x: {
                        grid: { color: 'rgba(255,255,255,0.1)' }
                    }
                },
                plugins: {
                    legend: { labels: { color: 'white' } },
                    tooltip: { callbacks: { label: (context) => context.dataset.label + ': ' + fmtMoney(context.parsed.y) } }
                }
            }
        });

        const categoryCtx = $('#categoryChart').getContext('2d');
        categoryChart = new Chart(categoryCtx, {
            type: 'pie',
            data: {
                labels: categories,
                datasets: [{
                    data: amounts,
                    backgroundColor: ['#ef4444', '#f59e0b', '#22c55e', '#3b82f6', '#8b5cf6', '#a855f7', '#ec4899', '#f97316'],
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'right', labels: { color: 'white' } },
                    tooltip: { callbacks: { label: (context) => context.label + ': ' + fmtMoney(context.parsed) } }
                }
            }
        });
    }

    function showSettlement() {
        const resultDiv = $('#settlementResult');
        resultDiv.innerHTML = '';
        
        const partners = state.data.partners;
        const netBalances = state.partnerNetBalances;
        
        if (partners.length < 2) {
            resultDiv.innerHTML = '<p class="muted">At least 2 partners are needed for settlement.</p>';
            return;
        }

        const debtors = [];
        const creditors = [];

        for (const id in netBalances) {
            if (netBalances[id] > 0) {
                creditors.push({ id, amount: netBalances[id] });
            } else if (netBalances[id] < 0) {
                debtors.push({ id, amount: Math.abs(netBalances[id]) });
            }
        }

        creditors.sort((a, b) => b.amount - a.amount);
        debtors.sort((a, b) => b.amount - a.amount);

        if (debtors.length === 0 && creditors.length === 0) {
            resultDiv.innerHTML = '<p class="positive">All accounts are settled. Everyone paid their equal share.</p>';
            return;
        }

        const h4 = document.createElement('h4');
        h4.textContent = 'Who pays whom:';
        resultDiv.appendChild(h4);

        let i = 0, j = 0;
        while (i < debtors.length && j < creditors.length) {
            const debtor = debtors[i];
            const creditor = creditors[j];
            const transferAmount = Math.min(debtor.amount, creditor.amount);

            const payerName = state.partnersMap.get(debtor.id)?.name || '‚Äî';
            const payeeName = state.partnersMap.get(creditor.id)?.name || '‚Äî';
            
            const p = document.createElement('p');
            p.innerHTML = `${payerName} owes ${payeeName} <span class="negative">${fmtMoney(transferAmount)}</span>`;
            resultDiv.appendChild(p);

            debtor.amount -= transferAmount;
            creditor.amount -= transferAmount;

            if (debtor.amount < 0.01) i++; // Use tolerance for floating point
            if (creditor.amount < 0.01) j++;
        }
    }

    function renderAll(){
      buildPartnersMap();
      calculateBalances();
      renderSummary();
      renderPartnerSelects();
      renderPartners();
      renderLedger();
      renderCharts();
    }

    // ====== Actions ======
    function addPartner(){
      const name = $('#pName').value.trim();
      const note = $('#pNote').value.trim();
      const role = $('#pRole').value;
      if(!name) return toast('‡§®‡§æ‡§Æ ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï ‡§π‡•à');
      state.data.partners.push({id:uid(), name, note, role, createdAt:new Date().toISOString()});
      $('#pName').value=''; $('#pNote').value='';
      saveData(); renderAll();
    }

    async function addEntry(){
      const type = $('#eType').value;
      const amount = parseFloat($('#eAmount').value);
      const date = $('#eDate').value || today();
      const by = $('#eBy').value || '';
      const category = $('#eCat').value.trim();
      const note = $('#eNote').value.trim();
      const file = $('#eFile').files[0];

      if(!amount || amount<=0) return toast('Valid amount ‡§°‡§æ‡§≤‡•á‡§Ç');
      if(!by) return toast('Paid By ‡§ö‡•Å‡§®‡•á‡§Ç');

      let attachmentUrl = '';
      if(file){
        toast('Uploading file...');
        const formData = new FormData();
        formData.append('image', file);
        formData.append('key', ImgbbAPIKey);
        try {
            const response = await fetch('https://api.imgbb.com/1/upload', {
                method: 'POST',
                body: formData
            });
            const result = await response.json();
            if(result.success){
                attachmentUrl = result.data.url;
                toast('File uploaded successfully!');
            } else {
                console.error('Imgbb upload failed:', result);
                toast('File upload failed!');
                return;
            }
        } catch(err) {
            console.error('Imgbb API error:', err);
            toast('File upload failed!');
            return;
        }
      }

      const e = {
          id:uid(), type, amount, date, by, category, note,
          createdAt:new Date().toISOString(),
          addedBy: currentUser.id,
          attachmentUrl
      };
      state.data.entries.push(e);
      $('#eAmount').value=''; $('#eCat').value=''; $('#eNote').value=''; $('#eFile').value = '';
      saveData(); renderAll();
    }

    function editPartner(id){
      if(currentUser.role !== 'admin') return toast('Permission denied.');
      const p = state.data.partners.find(x=>x.id===id); if(!p) return;
      const name = prompt('Update name', p.name); if(name===null) return;
      const note = prompt('Update note', p.note||''); if(note===null) return;
      const role = prompt('Update role (admin/member)', p.role||'member'); if(role===null) return;
      p.name = name.trim(); p.note = note.trim(); p.role = role.trim();
      saveData(); renderAll();
    }

    function deletePartner(id){
      if(currentUser.role !== 'admin') return toast('Permission denied.');
      const used = (state.data.entries||[]).some(e=>e.by===id);
      if(used) return toast('Cannot delete: entries exist for this partner');
      if(!confirm('Delete partner?')) return;
      state.data.partners = state.data.partners.filter(x=>x.id!==id);
      saveData(); renderAll();
    }

    function editEntry(id){
      const e = state.data.entries.find(x=>x.id===id); if(!e) return;
      if(currentUser.role !== 'admin' && e.by !== currentUser.id) return toast('Permission denied.');
      
      const amount = prompt('Amount (‚Çπ)', e.amount); if(amount===null) return;
      const date = prompt('Date (YYYY-MM-DD)', e.date||today()); if(date===null) return;
      const by = prompt('By (partner id)', e.by||''); if(by===null) return;
      const category = prompt('Category', e.category||''); if(category===null) return;
      const note = prompt('Notes', e.note||''); if(note===null) return;
      
      Object.assign(e,{
          amount:parseFloat(amount)||e.amount, date, by, category, note,
          updatedAt: new Date().toISOString(),
          updatedBy: currentUser.id
      });
      saveData(); renderAll();
    }

    function deleteEntry(id){
      if(currentUser.role !== 'admin') return toast('Permission denied.');
      if(!confirm('Delete this entry?')) return;
      state.data.entries = state.data.entries.filter(x=>x.id!==id);
      saveData(); renderAll();
    }

    function exportJSON(){
      const blob = new Blob([JSON.stringify(state.data,null,2)],{type:'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'bazaarika-ledger.json';
      a.click();
    }

    function exportCSV(){
      const rows = [['id','type','amount','date','by','byName','category','note','attachmentUrl','addedBy','createdAt','updatedBy','updatedAt']];
      const map = state.partnersMap;
      (state.data.entries||[]).forEach(e=>{
        rows.push([
            e.id,e.type,e.amount,e.date,e.by,
            (map.get(e.by)?.name||''),
            e.category||'',
            (e.note||'').replace(/\n/g,' '),
            e.attachmentUrl || '',
            e.addedBy || '',
            e.createdAt || '',
            e.updatedBy || '',
            e.updatedAt || ''
        ])
      });
      const csv = rows.map(r=>r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(',')).join('\n');
      const blob = new Blob([csv],{type:'text/csv'});
      const a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='bazaarika-ledger.csv'; a.click();
    }

    // ====== Events ======
    $('#btnLoad').addEventListener('click', fetchData);
    $('#btnInit').addEventListener('click', initializeBlob);
    $('#btnBackup').addEventListener('click', exportJSON);
    $('#btnCSV').addEventListener('click', exportCSV);
    $('#btnSettlement').addEventListener('click', showSettlement);

    $('#addPartner').addEventListener('click', addPartner);
    $('#addEntry').addEventListener('click', addEntry);
    $('#resetEntry').addEventListener('click', ()=>{
      $('#eAmount').value=''; $('#eCat').value=''; $('#eNote').value=''; $('#eType').value='contribution'; $('#eDate').value=today();
    });

    $('#partnerSearch').addEventListener('input', renderPartners);
    $('#refreshPartners').addEventListener('click', renderPartners);

    $('#applyFilter').addEventListener('click', renderLedger);
    $('#clearFilter').addEventListener('click', ()=>{ $('#fType').value=''; $('#fBy').value=''; $('#fText').value=''; renderLedger(); });

    $('#partnersTbl').addEventListener('click', (e)=>{
      const btn = e.target.closest('button'); if(!btn) return;
      const id = btn.dataset.id; const act = btn.dataset.act;
      if(act==='editP') editPartner(id);
      if(act==='delP') deletePartner(id);
    });

    $('#ledgerTbl').addEventListener('click', (e)=>{
      const btn = e.target.closest('button'); if(!btn) return;
      const id = btn.dataset.id; const act = btn.dataset.act;
      if(act==='editE') editEntry(id);
      if(act==='delE') deleteEntry(id);
    });

    // ====== Init ======
    (function init(){
      $('#eDate').value = today();
      fetchData();
    })();
  </script>
</body>
</html>
